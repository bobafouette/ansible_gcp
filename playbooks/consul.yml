######
# Install consul on ubuntu
# Adapted from Hashicorp's official documentation: 
#   https://learn.hashicorp.com/tutorials/consul/get-started-install?in=consul/getting-started
######

- name: Install and configure
  hosts: consul-slave
  remote_user: root

  tasks:

  - name: Add HashiCorpâ€™s official GPG key
    when: inventory_hostname not in groups['coos']
    apt_key:
      url: https://apt.releases.hashicorp.com/gpg
      state: present
    become: yes

  - name: Add HashiCorp's Repository
    when: inventory_hostname not in groups['coos']
    apt_repository:
    # Small magic trick here, using ansible fact's to get ubuntu's version "nickname"
      repo: deb https://apt.releases.hashicorp.com {{ ansible_distribution_release }} main
      state: present
    become: yes

  - name: Update and install consul
    when: inventory_hostname not in groups['coos']
    apt:
      name:
        - consul
      state: latest
      update_cache: yes
    become: yes

  - name: Start consul as server
    when: inventory_hostname in groups['coos']
    docker_container:
      name: consul-agent
      image: consul
      # volumes:
      #   - /data
      ports:
        - 8500:8500
        - 8600:8600/udp
      command: agent -bootstrap-expect=1 -enable-script-checks=true  -data-dir=/tmp/consul -config-dir=/etc/consul.d

    - name: Execute consul join
      community.docker.docker_container_exec:
        container: consul-agent
        command: consul join {{ ansible_default_ipv4.address}}
        chdir: /root
      register: result
